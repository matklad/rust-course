= Rust 2019
–ê–ª–µ–∫—Å–µ–π –ö–ª–∞–¥–æ–≤ <aleksey.kladov@gmail.com>
:icons: font
:lecture: –õ–µ–∫—Ü–∏—è 7: –û–±—ä–µ–∫—Ç—ã, —Å—Ç—Ä–æ–∫–∏
:table-caption!:
:example-caption!:

[.title-slide]
== impl Trait

== –ö–∞–∫ –≤–µ—Ä–Ω—É—Ç—å –∏—Ç–µ—Ä–∞—Ç–æ—Ä?

[source,rust]
----
fn random(n: usize) -> Vec<u32> {
    let mut r = 92;
    std::iter::repeat_with(move || {
        r ^= r << 13;
        r ^= r >> 17;
        r ^= r << 5;
        r
    }).take(n).collect()
}
----

* –Ω–µ –≥–∏–±–∫–æ -- –∞–ª–ª–æ—Ü–∏—Ä—É–µ–º `Vec`

== –ö–∞–∫ –≤–µ—Ä–Ω—É—Ç—å –∏—Ç–µ—Ä–∞—Ç–æ—Ä?

[source,rust]
----
fn random<T: FromIterator<u32>>(n: usize) -> T {
    let mut r = 92;
    std::iter::repeat_with(move || {
        r ^= r << 13;
        r ^= r >> 17;
        r ^= r << 5;
        r
    }).take(n).collect()
}
----

* –ª—É—á—à–µ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ —É–¥–æ–±–Ω–æ, –Ω–µ —Ö–æ—á–µ—Ç—Å—è –¥—É–º–∞—Ç—å –ø—Ä–æ `n`

== –ö–∞–∫ –≤–µ—Ä–Ω—É—Ç—å –∏—Ç–µ—Ä–∞—Ç–æ—Ä?

[source,rust]
----
fn random() -> ??? {
    let mut r = 92;
    std::iter::repeat_with(move || {
        r ^= r << 13;
        r ^= r >> 17;
        r ^= r << 5;
        r
    })
}
----

* –Ω–∞–ø–∏—Å–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø –Ω–µ –º–æ–∂–µ–º –∏–∑-–∑–∞ –ª—è–º–±–¥—ã
* –Ω–∞–ø–∏—Å–∞—Ç—å `+-> Iterator<Item = u32>+` –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è --  +
`Iterator` —ç—Ç–æ –Ω–µ —Ç–∏–ø

== –ü–æ–ø—ã—Ç–∫–∞ 1

[source,rust]
----
fn random<T: Iterator<Item = u32>>() -> T {
    let mut r = 92;
    std::iter::repeat_with(move || {
        r ^= r << 13;
        r ^= r >> 17;
        r ^= r << 5;
        r
    })
}
----

== –ü–æ–ø—ã—Ç–∫–∞ 1

* –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: –≤—ã–∑—ã–≤–∞—é—â–∏–π –∫–æ–¥ –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø `T`:
+
[source,rust]
----
struct MyIter;
impl Iterator for MyIter { type Item = u32; ...  }

fn main() {
    let _ = random::<MyIter>();
}
----

* "—è –º–æ–≥—É –≤–µ—Ä–Ω—É—Ç—å **–ª—é–±–æ–π** `T` –¥–ª—è –∫–æ—Ç–æ–≥–æ –≤–µ—Ä–Ω–æ +
  ``T: Iterator<Item = u32>``"

* –Ω—É–∂–Ω–æ "**—Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –∫–∞–∫–æ–π-—Ç–æ ``T: Iterator<Item = u32>``"

== impl Trait

[source,rust]
----
fn random() -> impl Iterator<Item = u32> {
    let mut r = 92;
    std::iter::repeat_with(move || {
        r ^= r << 13;
        r ^= r >> 17;
        r ^= r << 5;
        r
    })
}
----

* [.language-rust]`+-> impl Trait+` –Ω–µ —Ç–∏–ø, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Ç–∏–ø–æ–≤ (`+-> auto+` –Ω–µ—Ç)
* –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–∞—à–∏–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ –∑–Ω–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø, –Ω–æ –≤—ã–≤–æ–¥ —Ç–∏–ø–æ–≤ –∑–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ `: Trait`
* –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Ç–∏–ø–∞ –ø–æ–ª—è

== impl Trait

[.language-rust]`impl Trait` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–∞—Ö–∞—Ä–∞ –¥–ª—è —Ç–∏–ø–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

[source,rust]
----
fn process(items: impl Iterator<Item = Foo>) {

}

fn process<I: Iterator<Item = Foo>>(items: I) {

}
----

* –∞—Ä–≥—É–º–µ–Ω—Ç: *forall*
* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: *exists*

[.title-slide]
== dyn Trait

== !

[source,rust]
----
trait Say {
    fn say(&self);
}

impl Say for Cat { ... }
impl Say for Dog { ... }

fn main() {
    let mut animals = Vec::new();
    animals.push(Cat::new("Garfield"));
    animals.push(Dog::new("The Hound of the Baskervilles"));
    for animal in animals.iter() {
        animal.say();
    }
}
----

* –Ω–µ–ª—å–∑—è —Å–ª–æ–∂–∏—Ç—å `Cat` –∏ `Dog` –≤ –≤–µ–∫—Ç–æ—Ä -- —Ä–∞–∑–Ω—ã–π —Ç–∏–ø –∏ —Ä–∞–∑–º–µ—Ä
* —á–∞—Å—Ç–∏—á–Ω–æ —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É –≤ —Å–ª—É—á–∞–µ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏


== –¢–∞–±–ª–∏—Ü–∞ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –§—É–Ω–∫—Ü–∏–π

–í Java —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –∏ `Cat`, –∏ `Dog` -- —É–∫–∞–∑–∞—Ç–µ–ª–∏:

image::vtable.svg[width=100%]


== –¢–∞–±–ª–∏—Ü–∞ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –§—É–Ω–∫—Ü–∏–π

–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ –ø–∞–ª—å—Ü–∞—Ö:

–¢–∞–±–ª–∏—Ü–∞ –≤–∏—Ä—É–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π -- —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ —É–∫–∞–∑–∞—Ç–µ–ª–µ–π –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–∏. –§—É–Ω–∫—Ü–∏–∏
–Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü.

image::single_inheritance.svg[width=700]

[.centered]
== –¢–∞–±–ª–∏—Ü–∞ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –§—É–Ω–∫—Ü–∏–π

[NOTE.question]
–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–±–ª–∏—Ü–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –∫–ª–∞—Å—Å–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏?

https://lukasatkinson.de/2018/interface-dispatch/
https://wiki.openjdk.java.net/display/HotSpot/VirtualCalls
https://wiki.openjdk.java.net/display/HotSpot/InterfaceCalls


== –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤ C++

–í–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ -- –Ω–µ—Å–∫–æ–ª—å–∫–æ `vtable*` (–ø–æ –æ–¥–Ω–æ–π –Ω–∞ –∫–∞–∂–¥—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å).

–ö–∞—Å—Ç `Derived*` –∫ `Base*` —ç—Ç–æ coercion, –∑–Ω–∞—á–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è –º–µ–Ω—è–µ—Ç—Å—è.

–°–ª–µ–¥—Å—Ç–≤–∏–µ: +
–ù–µ–ª—å–∑—è –ø—Ä–∏–≤–µ—Å—Ç–∏ `vector<Derived*>` –∫ `vector<Base*>`

== –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤ Java

–í Java, `List<Derived>` *–º–æ–∂–Ω–æ* –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ `List<Base>`.

–í–º–µ—Å—Ç–æ VTable -- —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–ª–∞—Å—Å. –í –∫–ª–∞—Å—Å–µ -- —Å–ø–∏—Å–æ–∫ VTable–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –î–ª—è –≤—ã–∑–æ–≤–∞ –º–µ—Ç–æ–¥–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞–¥–æ —á–µ—Å—Ç–Ω–æ –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤
—Å–ø–∏—Å–∫–µ.

NOTE: JIT –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–∏ –≤—Å—ë –∏–Ω–ª–∞–π–Ω–∏—Ç

== thin pointer

VTable –º–æ–∂–Ω–æ —Å–ª–æ–∂–∏—Ç—å –≤ –æ–±—ä–µ–∫—Ç (C++, C#, Java):

image::thin.svg[width=100%]

== fat pointer

–ù–æ –º–æ–∂–Ω–æ –ø–æ–ª–æ–∂–∏—Ç—å –∏ —Ä—è–¥–æ–º —Å —É–∫–∞–∑–∞—Ç–µ–ª–µ–º (Rust, Go):

image::fat.svg[width=100%]

== !

[.language-rust]`dyn Trait`, trait object::
–¢–æ–ª—Å—Ç—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å: –ø–∞—Ä–∞ –∏–∑ —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –¥–∞–Ω–Ω—ã–µ –∏ —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

[source,rust]
----
trait Say {
    fn say(&self);
}

fn main() {
    let cat: Cat = Cat::new("Garfield");
    let cat: &dyn Say = &cat;
    let dog: Dog = Dog::new("The Hound of the Baskervilles");
    let dog: &dyn Say = &dog;
    let animals = vec![cat, dog];
    for animal in animals.iter() {
        animal.say();
    }
}
----

== !

[source,rust]
----
trait Say {
    fn say(&self);
}

impl Say for i32 {
    fn say(&self) {
        println!("hm... int-int?")
    }
}

fn main() {
    let i: i32 = 92;
    let i: &dyn Say = &i;
    let animals = vec![i];
    for animal in animals.iter() {
        animal.say();
    }
}
----

[.centered]
== !

.–ó–∞–º—ã–∫–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å [.language-rust]`dyn Trait`:
[source,rust]
----
type Callback = Box<dyn Fn(u32) -> u32>;

fn adder(x: u32) -> Callback {
    Box::new(move |y| x + y)
}

fn multiplier(x: u32) -> Callback {
    Box::new(move |y| x * y)
}
----

[.language-rust]`+Box<dyn Fn(T) -> U>+` -- –∞–Ω–∞–ª–æ–≥ `std::function`


== dyn Trait

–¢—Ä–µ–π—Ç—ã –º–µ—Ö–∞–Ω–∏–∑–º –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ, –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º–∞

Dynamic dispatch —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —á—É–∂–∏—Ö —Ç–∏–ø–æ–≤

.[.language-rust]`dyn Trait` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å –ª—é–±—ã–º —É–∫–∞–∑–∞—Ç–µ–ª–µ–º:
[source]
----
size_of::<&dyn Say>()
  == size_of::<Box<dyn Say>>()
  == size_of::<*const dyn Say>()
  == size_of::<usize>() * 2
----

== Dynamically Sized Types

`[T]` –∏ [.language-rust]`dyn Trait` —ç—Ç–æ –ø—Ä–∏–º–µ—Ä—ã DST: —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞ –Ω–µ
–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏. –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ DST -- —á–µ—Ä–µ–∑ —Ç–æ–ª—Å—Ç—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å.

–î–ª—è –Ω–µ DST —Ç–∏–ø–æ–≤ –≤–µ—Ä–Ω–æ `: Sized`. –¢–∏–ø–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `Sized`

.`std::mem`
[source,rust,subs=+quotes]
----
fn size_of<T>() -> usize                 // –Ω–µ—è–≤–Ω—ã–π where T: Sized
fn size_of_val<T: ##?Sized##>(val: &T) -> usize // —É–±—Ä–∞–ª–∏ ^
----

== Dynamically Sized Types

[source,rust]
----
pub trait Index<Idx: ?Sized> {
    type Output: ?Sized;

    fn index(&self, index: Idx) -> &Self::Output;
}

impl<T> Index<Range<usize>> for [T] {
    type Output = [T]; // unsized!
    fn index(&self, index: I) -> &[T]
}
----

CAUTION: –Ω–∞ —Å–ª–∞–π–¥–∞—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ª–µ–∫—Ü–∏–π —è –Ω–µ –ø–∏—Å–∞–ª `: ?Sized`

== Object Safety

–ù–µ –∏–∑ –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–π—Ç–∞ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å trait object

.–ù–µ–ª—å–∑—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å/–ø—Ä–∏–Ω–∏–º–∞—Ç—å `Self` –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é:
[source,rust]
----
trait Clone {
    fn clone(&self) -> Self;
}
----

.–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Å—Å–æ—Ü–∏–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
[source,rust]
----
trait Default {
    fn default() -> Self;
}
----

.–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:
[source,rust]
----
trait Hash {
    fn hash<H: Hasher>(&self, state: &mut H)
}
----

== –ö–æ–≥–¥–∞ Self: Sized

[source,rust]
----
trait ObjectSafe {
    fn ok(&self);

    fn generic<T>(&self, t: T)
        where Self: Sized;

    fn bad_self() -> Self
        where Self: Sized;
}

fn foo(obj: &dyn ObjectSafe) {
    obj.ok();
    // the `generic` method cannot be invoked on a trait object
    // obj.generic::<i32>(92)
}
----

–¢–æ–ª—å–∫–æ –Ω–µ `Self: Sized` –º–µ—Ç–æ–¥—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç object safety

== Iterator

[source,rust]
----
trait Iterator {
    type Item;
    fn next(&mut self) -> Option<Self::Item>; // object safe

    fn map<B, F>(self, f: F) -> Map<Self, F> // object safe!
        where Self: Sized, F: FnMut(Self::Item) -> B,
    { Map { iter: self, f } }

    ...
}
----


–ò–∑ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å [.language-rust]`Box<dyn Iterator<Item = T>>`, –∞–Ω–∞–ª–æ–≥ `Iterator<E>` –∏–∑ Java. –¶–µ–Ω–∞: –∞–ª–ª–æ–∫–∞—Ü–∏—è –≤ –∫—É—á–µ –∏ dynamic dispatch –Ω–∞ –≤–Ω–µ—à–Ω–µ–º —Å–ª–æ–µ.

== Iterator

[source,rust]
----
fn with_any_iterator(it: &mut dyn Iterator<Item = u32>) {
    let first = it.next(); // ok, next is object safe
    let it = it.filter(|it| it > 100) // ???
}
----

–ù–∞ [.language-rust]`dyn Iterator` –º–æ–∂–Ω–æ –ø–æ–∑–≤–∞—Ç—å `.next`, –Ω–æ –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ
–¥–µ–ª–∞—Ç—å —Å –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∞–º–∏:

[source,rust]
----
fn filter_map<B, F>(self, f: F) -> FilterMap<Self, F>
    where Self: Sized, F: FnMut(Self::Item) -> Option<B>,
{ FilterMap { iter: self, f } }
----

–ù–∞—à Self —ç—Ç–æ [.language-rust]`&mut dyn Iterator`

== Iterator

[source,rust]
----
impl<I: Iterator + ?Sized> Iterator for &mut I {
    type Item = I::Item;
    fn next(&mut self) -> Option<I::Item> { (
        **self).next()
    }
    fn size_hint(&self) -> (usize, Option<usize>) {
        (**self).size_hint()
    }
    fn nth(&mut self, n: usize) -> Option<Self::Item> {
        (**self).nth(n)
    }
}
----

[.language-rust]`dyn Iterator` —ç—Ç–æ `: Iterator` => +
[.language-rust]`&mut dyn Iterator` -- —Ç–æ–∂–µ `: Iterator`

== –§–∏–ª–æ—Å–æ—Ñ–∏—è

Dynamic dispatch -- –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –≤—ã–∑–æ–≤ –Ω–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∫–æ–¥–∞

–û—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–ª–∞–≥–∏–Ω–æ–≤, –Ω–æ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ –∫–æ–¥–∞

–ù–∞—Ä—É—à–∞–µ—Ç inline, —Ç—Ä–µ–±—É–µ—Ç –∫–æ—Å–≤–µ–Ω–Ω–æ—Å—Ç–∏ => –Ω–µ —Å—É–ø–µ—Ä –±—ã—Å—Ç—Ä—ã–π

–í —Ü–µ–ª–æ–º, [.language-rust]`dyn Trait` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ

[.title-slide]
== –°—Ç—Ä–æ–∫–∏

== std::fmt::Debug –∏ std::fmt::Display

–¢—Ä–µ–π—Ç—ã `Debug` –∏ `Display` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Å—Ç—Ä–æ–∫–∏.

[source,rust]
----
let text = "hello\nworld ";
println!("{}", text);   // Display
println!("{:?}", text); // Debug
----

[source, sh]
----
$ ./main
hello
world
"hello\nworld "
----

`Display` –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è =
`Debug` –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞

== !

[source,rust]
----
#[derive(Debug)] // Debug –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
struct Foo {
    x: i32
}

fn main() {
    let xs = vec![Foo { x: 1 }, Foo { x: 2 }],
    eprintln!("{:?}", xs);
    eprintln!("{:#?}", xs); // # –≤–∫–ª—é—á–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
}
----

[source]
----
$ ./main
[Foo { x: 1 }, Foo { x: 2 }]
[
    Foo {
        x: 1
    },
    Foo {
        x: 2
    }
]
----

== –î–∏–∑–∞–π–Ω

[source,rust]
----
trait Display {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result;
}
----

.–í–æ–∑–≤—Ä–∞—â–∞—Ç—å `String` –ø–ª–æ—Ö–æ:
* –µ—Å–ª–∏ –≤—ã–≤–æ–¥–∏–º —Å—Ä–∞–∑—É –≤ —Ñ–∞–π–ª, —Ç–æ –Ω–µ–Ω—É–∂–Ω–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è
* –º–æ–∂–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å –≤ –±—É—Ñ–µ—Ä –Ω–∞ —Å—Ç–µ–∫–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
* `N` –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π –¥–ª—è –ø–æ–¥–æ–±—ä–µ–∫—Ç–æ–≤

== –î–∏–∑–∞–π–Ω

.Formatter –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ:
[source,rust]
----
pub struct Formatter<'a> {
    flags: u32,
    fill: char,
    align: rt::v1::Alignment,
    width: Option<usize>,
    precision: Option<usize>,

    buf: &'a mut (dyn Write+'a), // trait object / NVI
    curarg: slice::Iter<'a, ArgumentV1<'a>>,
    args: &'a [ArgumentV1<'a>],
}

impl<'a> Formatter<'a> {
    fn write_str(&mut self, data: &str) -> fmt::Result;
    ...
}
----

== ToString

[source,rust]
----
pub trait ToString { <1>
    fn to_string(&self) -> String;
}

impl<T: fmt::Display + ?Sized> ToString for T {
    fn to_string(&self) -> String {
        use core::fmt::Write;
        let mut buf = String::new();
        buf.write_fmt(format_args!("{}", self)) <2>
           .expect("Display returned an error unexpectedly");
        buf.shrink_to_fit();
        buf
    }
}
----

<1> `ToString` -- —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–∑–≤–∞—Ç—å `.to_string`
<2> `format_args`: –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω —Å—Ç—Ä–æ–∫–∏

== String

.–°—Ç—Ä–æ–∫–∏ –≤ Rust —É—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–æ—Å—Ç–æ:
[source,rust]
----
pub struct String {
    vec: Vec<u8>,
}
----

–í–µ–∫—Ç–æ—Ä –±–∞–π—Ç + **–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç**, —á—Ç–æ –≤ –±–∞–π—Ç–∞—Ö –≤–∞–ª–∏–¥–Ω—ã–π UTF-8

== UTF-8

Variable length encoding, —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å ASCII, 1 –±–∞–π—Ç –¥–ª—è latin-1

[source]
----
a  : 0x61
—ã  : 0xd1 0x8b
üòÄ : 0xf0 0x9f 0x98 0x80
----

UTF-8 -- –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

WARNING: –Ω–µ—Ç random access –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏–º–≤–æ–ª—É (–≤ —Ü–µ–ª–æ–º –Ω–µ –ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —Ç–∞–∫–æ–µ —Å–∏–º–≤–æ–ª)

== UCS-2 / UTF-16

–í 1991 –≥–æ–¥—É –¥—É–º–∞–ª–∏, —á—Ç–æ 65536 —Å–∏–º–≤–æ–ª–æ–≤ —Ö–≤–∞—Ç–∏—Ç –≤—Å–µ–º: UCS-2 —ç—Ç–æ fixed width (16
–±–∏—Ç) –∫–æ–¥–∏—Ä–æ–≤–∫–∞ —Å random access.

–ú–Ω–æ–≥–æ —Å–∏—Å—Ç–µ–º –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ UCS-2 (Java, Windows, JavaScript).

–í 1996 UCS-2 —Ä–∞—Å—à–∏—Ä–∏–ª–∏ –¥–æ `UTF-16`: –ø–∞—Ä–∞ —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –∫–æ–¥–∏—Ä—É–µ—Ç –æ–¥–∏–Ω code point –≤–Ω–µ BMP.

`UTF-16` -- —Ç–æ–∂–µ variable length, –Ω–µ random access.

–ú–Ω–æ–≥–∏–µ —è–∑—ã–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç UTF-16 —Å API UCS-2: –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–æ–∫–µ.


== API

[source,rust]
----
impl String {
    fn new() -> String;
    fn with_capacity(capacity: usize) -> String; <1>
    fn from_utf8(vec: Vec<u8>) -> Result<String, FromUtf8Error>; <2>
    fn from_utf16(v: &[u16]) -> Result<String, FromUtf16Error>; <3>
    fn into_bytes(self) -> Vec<u8>;
}

impl FromUtf8Error {
    fn into_bytes(self) -> Vec<u8>; <4>
}
----

<1> —Å—Ç—Ä–æ–∫–∏ –∏–∑–º–µ–Ω—è–µ–º—ã–µ (–µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å [.language-rust]`&mut`)
<2> –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ UTF-8 –Ω–µ –∫–æ–ø–∏—Ä—É–µ—Ç
<3> –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ UTF-6 –∫–æ–ø–∏—Ä—É–µ—Ç
<4> –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π –≤–µ–∫—Ç–æ—Ä –Ω–∞–∑–∞–¥

== str

`str` -- DST, `[u8]` + utf-8 –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç. +
`&str` -- —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –±–∞–π—Ç—ã + —Ä–∞–∑–º–µ—Ä, –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–∞—è —Å—Ç—Ä–æ–∫–∞

[source,rust]
----
impl Deref for String {
    type Target = str;
    ...
}

impl Index<Range<usize>> for String {
    type Output = str;
}
----

`&str` –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –∏–∑ `String` —á–µ—Ä–µ–∑  —Å–ª–∞–π—Å: `&s[1..10]`

–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å—Ç–∞–π—Å–∞ -- –ø–æ–∑–∏—Ü–∏–∏ –≤ –±–∞–π—Ç–∞—Ö +
–ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω—É —Å–∏–º–≤–æ–ª–∞ -- –ø–∞–Ω–∏–∫–∞

== –°—Ç—Ä–æ–∫–∏ –ë–µ–∑ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

[source,rust]
----
impl str {
    fn split_whitespace<'a>(&'a self) -> SplitWhitespace<'a>;
}

impl<'a> Iterator for SplitWhitespace<'a> {
    type Item = &'a str;
    ...
}
----

–ú–Ω–æ–≥–∏–µ –º–µ—Ç–æ–¥—ã –Ω–∞ `&String`  `&str` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `&str` -- zero copy

–í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞—Ä–æ–π Java –∏ JavaScript –Ω–µ–ª—å–∑—è –ø–æ–ª—É—á–∏—Ç—å memory leak: lifetime
`&str` –ø—Ä–∏–≤—è–∑–∞–Ω –∫ `String`

== char

|===
char
|===

–ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —Ç–∏–ø –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Unicode Codepoint, 32 –±–∏—Ç–∞

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–¥–∫–æ: –µ–¥–∏–Ω–∏—Ü–∞ —Ç–µ–∫—Å—Ç–∞ —ç—Ç–æ grapheme cluster

.API –∑–Ω–∞–µ—Ç –ø—Ä–æ Unicode:
[source,rust]
----
impl char {
    to_lowercase(self) -> ToLowercase; // –∏—Ç–µ—Ä–∞—Ç–æ—Ä!
}

impl Iterator for ToLowercase {
    type Item = char;
}
----

== API

[source,rust]
----
impl str {
    fn chars(&self) -> Char; // –∏—Ç–µ—Ä–∞—Ç–æ—Ä char–æ–≤

    fn to_ascii_lowercase(&self) -> String;
    fn make_ascii_uppercase(&mut self);

    // –Ω–µ–ª—å–∑—è –æ–±–æ–π—Ç–∏—Å—å –±–µ–∑ –∞–ª–ª–æ–∫–∞—Ü–∏–∏
    fn to_lowercase(&self) -> String;

    // –∏–Ω–¥–µ–∫—Å –≤ –±–∞–π—Ç–∞—Ö, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `[]`
    pub fn find<'a, P>(&'a self, pat: P) -> Option<usize>
        where P: Pattern<'a>;
    fn is_char_boundary(&self, index: usize) -> bool;

    fn as_bytes(&self) -> &[u8];
}

// std::str
pub fn from_utf8(v: &[u8]) -> Result<&str, Utf8Error>;
----

== –¶–µ–Ω–∞ –ê–±—Å—Ç—Ä–∞–∫—Ü–∏–∏

–í Rust –µ—Å—Ç—å –¥–≤–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π:

. —Å–ª–∞–π—Å—ã: `[T]`, `str`
. –∏—Ç–µ—Ä–∞—Ç–æ—Ä—ã: `Iterator<Item = T>`

–í —Ç–µ–æ—Ä–∏–∏, –¥–æ–ª–∂–Ω–æ —Ö–≤–∞—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–æ–≤

–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ, –∑–Ω–∞–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç—ã –ª–µ–∂–∞—Ç –≤ –ø–∞–º—è—Ç–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ø–æ–∑–≤–æ–ª—è–µ—Ç
–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å –º–Ω–æ–≥–∏–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`memcpy`, `memchr`, etc).

== CString / CStr

–ú–Ω–æ–≥–∏–µ FFI —Å—Ç—Ä–æ–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `char *` -- –±–∞–π—Ç—ã, —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ `0`

`String` –∏ `str` –Ω–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å `char *`: –Ω–µ—Ç –Ω—É–ª–µ–≤–æ–≥–æ –±–∞–π—Ç–∞ –≤ –∫–æ–Ω—Ü–µ, –Ω–µ—Ç
–≥–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–æ utf-8

`CString` -- –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `char *` –¥–ª—è FFI

WARNING: —á—Ç–æ–±—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å `String` –≤ `CString` –Ω—É–∂–Ω–∞ –∞–ª–ª–æ–∫–∞—Ü–∏—è

== OsString / OsStr

* —Å—Ç—Ä–æ–∫–∏ –≤ Unix -- –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã—Ö –±–∞–π—Ç–æ–≤
* —Å—Ç—Ä–æ–∫–∏ –≤ Windows -- "UTF-16" —Å –Ω–µ–ø–∞—Ä–Ω—ã–º–∏ —Å—É—Ä—Ä–æ–≥–∞—Ç–∞–º–∏

`OsString` –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –ª—é–±—É—é —Å—Ç—Ä–æ–∫—É –û–°. –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ -- WTF-8
(–Ω–∞–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ Unicode –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π —Å—Ç—Ä–æ–∫)

`String` —ç—Ç–æ `OsString`, `str` —ç—Ç–æ `OsStr`

== PathBuf / Path

`PathBuf` –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ `OsString` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏

–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç `/`, `\` –∫–∞–∫ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä—ã + –∫—É—á–∞ –ø–æ–ª–µ–∑–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤

NOTE: –ù–∞ windows `/` —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–µ–ø–∞—Ä–∞—Ç–æ—Ä–∞

== –ò—Ç–æ–≥–∏

–°—Ç—Ä–æ–∫ –º–Ω–æ–≥–æ. –õ—é–±–∞—è —Å—Ç—Ä–æ–∫–∞ -- –≤–µ–∫—Ç–æ—Ä –±–∞–π—Ç, –æ—Ç–ª–∏—á–∏–µ –≤ –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö

|===
|owned|String|CString|OsString|PathBuf
|borrowed|str|CStr|OsStr|Path
|===

`Os` –∏ `C` –≤–∞—Ä–∏–∞–Ω—Ç—ã -- —Ä–µ–¥–∫–∏–µ

UTF-8 + –±–∞–π—Ç–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã -- —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
